<!DOCTYPE html>
<html>
<head>
  <title>Regular Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="author" content="Harys Dalvi">
  <meta name="description" content="Free Calculator">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
      onload="renderMathInElement(document.body);"></script>
  <link rel="stylesheet" href="calcstyles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.0/math.min.js"></script>
  <script src="import.js"></script>
<style>
  body {
    background-color: #DDF0FF;
    font-family: "Baskerville", "Times New Roman";
    padding-left: 3%;
    padding-right: 3%;
    padding-top: 30px;
    padding-bottom: 70px;
    text-align: center;
  }
  .button {
    color: #FFFFFF;
    background-color: #0088AA;
    border: 1px solid #99AAFF;
    font-family: "Baskerville", "Times New Roman";
    width: 10%;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 3px;
    height: 18px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    -moz-user-select: none;
  }
  .button:hover {
    background-color: #0099CC;
  }
  img {
    width: 100%;
  }
  span.memeSpan {
    display: flex;
    justify-content: center;
    flex-direction: row;
    flex-wrap: wrap;
  }
  span.memeSpan img {
    width: 20%;
    height: 20%;
  }
  .noBottomMargin {
    margin-bottom: 0;
  }
  .noTopMargin {
    margin-top: 0;
  }
  @media only screen and (max-width: 650px) {
    body {
      padding-left: 3%;
      padding-right: 3%;
      margin: 0;
    }
    h1 {
      font-size: 28px;
    }
    div#calculator {
      padding: 3%;
    }
    div#screen {
      height: 50px;
    }
    div#mode {
      min-height: 50px;
    }
    .button {
      padding-left: 10px;
      padding-right: 10px;
      font-size: 70%;
    }
  }
  div#calculator {
    background-color: #AAE0EE;
    border: 1px solid #99D0DD;
    width: 90%;
    padding: 5%;
    margin: 0;
    position: relative;
  }
  div#screen,div#mode,div#prgm,div#selection {
    width: 80%;
    height: 100px;
    margin: auto;
    background-color: #446066;
    border: 1px solid #004044;
    padding: 2%;
    font-size: 18px;
    color: #FFFFFF;
    overflow: scroll;
    text-align: left;
  }
  div#mode {
    height: auto;
    min-height: 100px;
    font-size: 16px;
  }
  div.button.number {
    background-color: #EEEEFF;
    color: #000055;
  }
  div.button.number:hover {
    background-color: #DDDDEE;
  }
  div.button.operation {
    background-color: #333333;
  }
  div.button.operation:hover {
    background-color: #555555;
  }
  div.buttons div.button {
    display: inline-block;
  }
  div#mem {
    color: #CCCCCC;
    text-align: right;
  }
  div#membuffer,div#mode,div#punjab,div#prgm,div#selection {
    display: none;
  }
  span#cursor {
    color: #FF0000;
  }
  div.scrollbutton.button {
    background-color: #000000;
    color: #FFFFFF;
  }
  div#buttonrows {
    text-align: left;
  }
  div.button#second {
    background-color: #00EE22;
    color: #4444FF;
  }
  div.button#second:hover {
    background-color: #00BB44;
  }
  div.button.active#second {
    border: 1px solid #000000;
    background-color: #00FF33;
    color: #FFFFFF;
  }
  div.button.active#second:hover {
    background-color: #00CC66;
  }
  div.button#alpha {
    background-color: #FFEE22;
    color: #4444FF;
  }
  div.button#alpha:hover {
    background-color: #CCBB44;
  }
  div.button.active#alpha {
    border: 1px solid #000000;
    background-color: #FFFF33;
    color: #00CCFF;
  }
  div.button.active#alpha:hover {
    background-color: #EEEE66;
  }
  div#calculator h1, div#calculator h6 {
    text-align: center;
    color: #FFFFFF;
    margin: auto;
  }
  div.commandMem {
    text-align: left;
  }
  div#mem div.highlight {
    background-color: #666666;
  }
  div#prgm {
    font-family: monospace;
    font-size: 16px;
    overflow: scroll;
  }
  span#mi_txt {
    color: #333333;
  }
</style>
</head>
<body onkeypress="keypress(event)" onkeydown="specialkeys(event)">

<h3 class="noBottomMargin">Harys Dalvi's Aesthetically Pleasing</h3>
<h1 class="noTopMargin" id="sitename">Regular Calculator</h1>

<div id="calculator">

<div id="maharashtra">
<h1 id="calcname">MI-\(n\)spire CX II CAS</h1>
<h6><svg height="12" width="12" id="mi_svg">
  <polygon points="0,4 4,2 5,3 7,2.5 11,3 12,8 11,9 9,7 4,10 0,11" fill="rgb(51,51,51)"></polygon>
  <text x="2.6" y="5" fill="rgb(170,224,238)" font-size="8" id="mi_m" transform="rotate(10)">m</text>
  <text x="5.6" y="4" fill="rgb(51,51,51)" font-size="6" transform="rotate(10)">i</text>
  </svg>
<span id="mi_txt">Maharashtra Instruments</span></h6>
</div>
<div id="punjab">
<h1>PI-\(n\)spire CX II CAS</h1>
<h6 style="color: #333333"><svg height="12" width="12">
  <polygon points="0,12 2,8 3,5 5,3 7,4 10,5 12,7 11,9 7,8 4,11" fill="rgb(51,51,51)"></polygon>
  <text x="3.7" y="6" fill="rgb(170,238,224)" font-size="8" transform="rotate(10)">p</text>
  <text x="6.3" y="5.1" fill="rgb(51,51,51)" font-size="6" transform="rotate(10)">i</text>
  </svg>
Punjab Instruments</h6>
</div>
<br>
<div id="screen">
  <div id="mem"></div>
  <div id="ans"></div>
  <div id="membuffer">&emsp;</div>
</div>
<div id="mode">
  <form name="mode" action="javascript:void(0)">
    <input type="radio" name="angle" value="1">
    <label for="1">Degree</label><br>
    <input type="radio" name="angle" value="0">
    <label for="0">Radian</label><br><br>
    <input type="radio" name="notation" value="0">
    <label for="0">Normal</label><br>
    <input type="radio" name="notation" value="1">
    <label for="1">Scientific</label><br><br>
    <label for="logbase">Log base</label>
    <input type="number" name="logbase" value="10" min="0" step="any"><br>
    <input type="checkbox" name="debug">
    <label for="debug">Debug mode</label><br>
    <label for="color">Color scheme: </label><select name="color">
      <option value="">Harys</option>
      <option value="abdussalam">Abdus Salam</option>
      <option value="night">Night</option>
      <option value="cathy">Cathy</option>
      <option value="washington">Washington</option>
    </select>
  </form>
</div>
<div id="prgm">Program (JavaScript):<br>
<code id="prgm_txt" contenteditable="true">alert('Hello, world!');</code>
</div>
<div id="selection"><form name="selection" action="javascript:void(0)">
  <br>Select an option: <select name="choice"></select>
</form></div>
<br>
<div id="buttonrows">
<div class="buttons">
  <div class="button" id="second" onclick="secondbutton()">\(2^{\text{nd}}\)</div>
  <div class="button" onclick="quit()">\(\text{quit}\)</div>
  <div class="button" onclick="changeMode()" data-bpage="0">\(\text{mode}\)</div>
  <div class="button" onclick="editPrgm()" data-bpage="1">\(\text{prgm}\)</div>
  <div class="button" onclick="changeMode()" data-bpage="2">\(\text{mode}\)</div>
  <div class="scrollbutton button" onclick="scrollleft();" data-bpage="0">\(\leftarrow\)</div>
  <div class="scrollbutton button" onclick="scrollup();" data-bpage="1">\(\uparrow\)</div>
  <div class="scrollbutton button" onclick="scrollleft();" data-bpage="2">\(\leftarrow\)</div>
  <div class="scrollbutton button" onclick="scrollright();" data-bpage="0">\(\rightarrow\)</div>
  <div class="scrollbutton button" onclick="scrolldown();" data-bpage="1">\(\downarrow\)</div>
  <div class="scrollbutton button" onclick="scrollright();" data-bpage="2">\(\rightarrow\)</div>
</div>
<div class="buttons">
  <div class="button" id="alpha" onclick="alphabutton()">\(\text{alpha}\)</div>
  <div class="button" onclick="choosefunction(['¸{}', '¯{}'], ['floor', 'ceil']);" data-bpage="0">\( \text{math} \)</div>
  <div class="button" onclick="writescreen('ý')" data-bpage="1">\( \text{hyp} \)</div>
  <div class="button" onclick="choosefunction(['¸{}', '¯{}'], ['floor', 'ceil']);" data-bpage="2">\( \text{math} \)</div>
  <div class="button" onclick="writescreen('Ä');" data-bpage="0"> \( \lvert x \rvert \) </div>
  <div class="button" onclick="choosefunction(['!', '{}©{}', '{}¦{}', 'Â'], ['!', 'nCr', 'nPr', 'rand']);" data-bpage="1"> \( \text{prb} \) </div>
  <div class="button" onclick="writescreen('Ä');" data-bpage="2"> \( \lvert x \rvert \) </div>
  <div class="button" onclick="writescreen('*10^{}', true, false); cursor += 5; writescreen('');">\(\times10^n\)</div>
  <div class="button" onclick="deltxt();">\(\text{del}\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('Ł(')" data-bpage="0">\(\log\)</div>
  <div class="button" onclick="writescreen('10^{}', true, false); cursor += 4; writescreen('');" data-bpage="1">\(10^x\)</div>
  <div class="button" onclick="writescreen('Ł(')" data-bpage="2">\(\log\)</div>
  <div class="button" onclick="writescreen('ł(')" data-bpage="0">\(\ln\)</div>
  <div class="button" onclick="writescreen('è^{}', true, false); cursor += 3; writescreen('');" data-bpage="1">\(e^x\)</div>
  <div class="button" onclick="writescreen('ł(')" data-bpage="2">\(\ln\)</div>
  <div class="button" onclick="fracbutton();"> \(\frac{n}{d}\) </div>
  <div class="button" onclick="enter(true)">\( \text{f to d} \)</div>
  <div class="button" onclick="clearmem();" data-bpage="0">\(\text{clear}\)</div>
  <div class="button" onclick="clearallmem(); alert('MC: memory cleared (Minecraft)');" data-bpage="1">\(\text{MC}\)</div>
  <div class="button" onclick="clearmem();" data-bpage="2">\(\text{clear}\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('π')">\(\pi\)</div>
  <div class="button" onclick="writescreen('ì(')" data-bpage="0">\(\sin\)</div>
  <div class="button" onclick="writescreen('ç(')" data-bpage="0">\(\cos\)</div>
  <div class="button" onclick="writescreen('à(')" data-bpage="0">\(\tan\)</div>
  <div class="button" onclick="writescreen('Ì(')" data-bpage="1">\(\sin^{-1}\)</div>
  <div class="button" onclick="writescreen('Ç(')" data-bpage="1">\(\cos^{-1}\)</div>
  <div class="button" onclick="writescreen('À(')" data-bpage="1">\(\tan^{-1}\)</div>
  <div class="button" onclick="writescreen('ì(')" data-bpage="2">\(\sin\)</div>
  <div class="button" onclick="writescreen('ç(')" data-bpage="2">\(\cos\)</div>
  <div class="button" onclick="writescreen('à(')" data-bpage="2">\(\tan\)</div>
  <div class="button" onclick="writescreen('ÿ')">\(\text{\%}\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('^{}', true, false); cursor += 2; writescreen('');">\( \wedge \)</div>
  <div class="button" onclick="writescreen('^{-1}')">\(x^{-1}\)</div>
  <div class="button" onclick="writescreen('(')">\((\)</div>
  <div class="button" onclick="writescreen(')')">\()\)</div>
  <div class="operation button" onclick="writescreen('/')">\(\div\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('^{2}')" data-bpage="0">\(x^2\)</div>
  <div class="button" onclick="writescreen('^{3}')" data-bpage="1">\(x^3\)</div>
  <div class="button" onclick="writescreen('^{2}')" data-bpage="2">\(x^2\)</div>
  <div class="number button" onclick="writescreen('7')" data-bpage="0">\(7\)</div>
  <div class="number button" onclick="writescreen('8')" data-bpage="0">\(8\)</div>
  <div class="number button" onclick="writescreen('9')" data-bpage="0">\(9\)</div>
  <div class="number button" onclick="writescreen('7')" data-bpage="1">\(7\)</div>
  <div class="number button" onclick="writescreen('8')" data-bpage="1">\(8\)</div>
  <div class="number button" onclick="writescreen('9')" data-bpage="1">\(9\)</div>
  <div class="button" onclick="writescreen('¡')" data-bpage="2">\(a\)</div>
  <div class="button" onclick="writescreen('¤')" data-bpage="2">\(b\)</div>
  <div class="button" onclick="writescreen('¢')" data-bpage="2">\(c\)</div>
  <div class="operation button" onclick="writescreen('*')">\(\times\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('ù{}', true, false); cursor += 2; writescreen('');" data-bpage="0">\( \sqrt{x} \)</div>
  <div class="button" onclick="writescreen('Ù{}', true, false); cursor += 2; writescreen('');" data-bpage="1">\( \sqrt[3]{x} \)</div>
  <div class="button" onclick="writescreen('ù{}', true, false); cursor += 2; writescreen('');" data-bpage="2">\( \sqrt{x} \)</div>
  <div class="number button" onclick="writescreen('4')" data-bpage="0">\(4\)</div>
  <div class="number button" onclick="writescreen('5')" data-bpage="0">\(5\)</div>
  <div class="number button" onclick="writescreen('6')" data-bpage="0">\(6\)</div>
  <div class="number button" onclick="writescreen('4')" data-bpage="1">\(4\)</div>
  <div class="number button" onclick="writescreen('5')" data-bpage="1">\(5\)</div>
  <div class="number button" onclick="writescreen('6')" data-bpage="1">\(6\)</div>
  <div class="button" onclick="writescreen('£')" data-bpage="2">\(x\)</div>
  <div class="button" onclick="writescreen('¥')" data-bpage="2">\(y\)</div>
  <div class="button" onclick="writescreen('«')" data-bpage="2">\(z\)</div>
  <div class="operation button" onclick="writescreen('-')">\(-\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="writescreen('>')">\(\text{sto} \mapsto \)</div>
  <div class="number button" onclick="writescreen('1')" data-bpage="0">\(1\)</div>
  <div class="number button" onclick="writescreen('2')" data-bpage="0">\(2\)</div>
  <div class="number button" onclick="writescreen('3')" data-bpage="0">\(3\)</div>
  <div class="number button" onclick="writescreen('1')" data-bpage="1">\(1\)</div>
  <div class="number button" onclick="writescreen('2')" data-bpage="1">\(2\)</div>
  <div class="number button" onclick="writescreen('3')" data-bpage="1">\(3\)</div>
  <div class="button" onclick="writescreen('Þ')" data-bpage="2">\(t\)</div>
  <div class="button" onclick="writescreen('®')" data-bpage="2">\(r\)</div>
  <div class="button" onclick="writescreen('θ')" data-bpage="2">\( \theta \)</div>
  <div class="operation button" onclick="writescreen('+')">\(+\)</div>
</div>
<div class="buttons">
  <div class="button" onclick="alert('Haha funnee calculator already on')" data-bpage="0">\(\text{on}\)</div>
  <div class="button" onclick="execPrgm();" data-bpage="1">\(\text{exec}\)</div>
  <div class="button" onclick="alert('Haha funnee calculator already on')" data-bpage="2">\(\text{on}\)</div>
  <div class="number button" onclick="writescreen('0')" data-bpage="0">\(0\)</div>
  <div class="number button" onclick="writescreen('.')" data-bpage="0">\(.\)</div>
  <div class="button" onclick="writescreen('¶')" data-bpage="2">\(m\)</div>
  <div class="number button" onclick="writescreen('0')" data-bpage="1">\(0\)</div>
  <div class="number button" onclick="writescreen('.')" data-bpage="1">\(.\)</div>
  <div class="button" onclick="writescreen('ñ')" data-bpage="2">\(n\)</div>
  <div class="number button" onclick="negbutton()" data-bpage="0">\((-)\)</div>
  <div class="number button" onclick="writescreen('Å')" data-bpage="1">\(\text{ans}\)</div>
  <div class="button" onclick="writescreen('¿')" data-bpage="2">\(k\)</div>
  <div class="operation button" onclick="enter()">\(\text{enter}\)</div>
</div>
</div>

</div>

<div id="debug"></div>

<script>
var screentxt = "";
var buttons = document.getElementsByClassName("button");
var cursor = 0;
var memselect = -1;
var mathprint = true;
var clearWithButton = false;
var closebrackets = [")", "]", "}", "Ä"];
var openbrackets = ["(", "[", "{", "Ä"];
var operations = ["+", "-", "*", "/", "^", "!", "ÿ"];
var functions = ["ì", "ç", "à", "ł", "ù", "Ł", "Ì", "Ç", "À", "Ù", "¯", "¸"];
var variables = ["¡", "¤", "¢", "£", "¥", "«", "®", "Þ", "θ", "¶", "ñ", "¿"];
var digits = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
var automult = functions.concat(variables).concat(["è", "π"]).concat(["\\(", "\\{", "\\[", "Â"]);
var doublefunctions = ["^", "á", "©", "¦"];
var anglemode = 1;
var memDivs = [];
document.mode.angle.value = anglemode;
var notation = 0;
var logbase = 10;
document.mode.notation.value = notation;
var mem = [];
var commandmem = [];
var screenview = 0;
var buttonmode;
var debugmode = false;
const BIG_NUM = math.pow(10, 309);
const CMND_DEF = "\\newcommand{\\floor}[1]{\\left\\lfloor #1 \\right\\rfloor} \\newcommand{\\ceil}[1]{\\left\\lceil #1 \\right\\rceil}";
switchbutton(0);
function writescreen(str, add=true, render=true, mem=true) {
  if (screenview == 0) {
    if (str != "")
      memselect = -1;
    if (!add || clearWithButton) {
      screentxt = "";
      cursor = 0;
      clearWithButton = false;
    }
    if (add) {
      document.getElementById("ans").style.textAlign = "";
    }
    if (screentxt.length == 0 && mem) {
      updateMem();
    }
    if (add & screentxt.length == 0 && (operations.indexOf(str[0]) != -1 || str == ">")) {
      screentxt = "Å";
      cursor = 1;
    }
    screentxt = screentxt.slice(0, cursor) + str + screentxt.slice(cursor);
    if (render) {
      cursor += str.length;
      if (mathprint) {
        let txt = screentxt;
        if (cursor == screentxt.length && add) {
          txt = screentxt + " \\_ ";
        } else {
          if (closebrackets.indexOf(txt[cursor]) == -1 && openbrackets.indexOf(txt[cursor]) == -1) {
            txt = screentxt.slice(0, cursor) + " \\underline{ " + screentxt.slice(cursor, cursor+1) + "}" +
              screentxt.slice(cursor+1);
          } else {
            txt = screentxt.slice(0, cursor) + " ß " +
              screentxt.slice(cursor);
          }
        }
        txt = txt.replace(/{}á{}/g, "{ß}á{ß}");
        document.getElementById("ans").innerHTML = "\\(" + CMND_DEF + to_latex(txt) + "\\)";
        updateMath();
        document.getElementById("screen").scrollTop = document.getElementById("screen").scrollHeight;
        document.getElementById("screen").scrollLeft = document.getElementById("screen").scrollWidth;
      } else {
        document.getElementById("ans").innerHTML = to_eval(screentxt);
      }
      switchbutton(0);
    }
  }
}
function negbutton() {
  writescreen('-', true, false);
  if (screentxt.length == 2 && screentxt[0] == "Å") {
    screentxt = screentxt[1];
    cursor = 1;
  } else {
    cursor++;
  }
  writescreen('');
}
function updateMem(lastmem=true) {
  document.getElementById("membuffer").style.display = "";
  let membox = document.getElementById("mem");
  membox.innerHTML = "";
  let shift = 1;
  if (lastmem) shift = 0;
  for (var i = 0; i < mem.length-shift; i++) {
    membox.innerHTML += "<div class='commandMem'>\\( " + CMND_DEF + to_latex(commandmem[i]) + "\\)</div>";
    membox.innerHTML += "<div>\\( " + mem[i] + "\\)</div>";
  }
  if (commandmem.length > mem.length-shift && mem.length-shift > -1) {
    for (var i = mem.length-shift; i < commandmem.length; i++) {
      membox.innerHTML += "<div class='commandMem'>\\( " + CMND_DEF + to_latex(commandmem[i]) + "\\)</div>";
    }
  }
  let allDivs = document.getElementsByTagName("div");
  memDivs = [];
  for (var i = 0; i < allDivs.length; i++) {
    if (membox.contains(allDivs[i]) && membox != allDivs[i])
      memDivs.push(allDivs[i]);
  }
  if (memselect >= 0 && memselect < memDivs.length)
    memDivs[memselect].className += " highlight";
  document.getElementById("screen").scrollTop = document.getElementById("screen").scrollHeight;
}
function updateMath() {
  renderMathInElement(document.getElementById("screen"));
  if (debugmode) {
    document.getElementById("debug").innerHTML = "screentxt: " + screentxt + "<br>LATEX: " + to_latex(screentxt) +
      "<br>eval: " + to_eval(screentxt) + "<br>screentxt[cursor]: " + screentxt[cursor];
  }
  document.getElementById("screen").scrollTop = document.getElementById("screen").scrollHeight;
}
function to_eval(str) {
  for (var i = 0; i < automult.length; i++) {
    let re = new RegExp("[0-9]" + automult[i], 'g');
    str = str.replace(re, function(match) {
      return match[0] + "*" + match[1];
    });
  }
  for (var i = 0; i < str.length-1; i++) {
    if (variables.indexOf(str[i]) != -1 && variables.indexOf(str[i+1]) != -1) {
      str = str.slice(0, i+1) + "*" + str.slice(i+1);
      i++;
    }
    if ((["(", "["].indexOf(str[i+1]) != -1 || functions.indexOf(str[i+1]) != -1) && automult.indexOf(str[i]) != -1
        && functions.indexOf(str[i]) == -1 && str[i] != "Ä") {
      str = str.slice(0, i+1) + "*" + str.slice(i+1);
      i++;
    }
    if (closebrackets.indexOf(str[i]) != -1 && automult.indexOf(str[i+1]) != -1 && str[i] != "Ä") {
      str = str.slice(0, i+1) + "*" + str.slice(i+1);
      i++;
    }
  }
  while (str.indexOf("^") != -1) {
    var i = str.indexOf("^");
    let exponent = str.slice(i+2, findClosingBracket(str, i+1, open='{', close='}'));
    var j = i - 1;
    for (var b = 0; b < closebrackets.length; b++) {
      if (str[j] == closebrackets[b]) {
        j = findOpeningBracket(str, j, open=openbrackets[b], close=closebrackets[b]);
        if (j > 0 && functions.indexOf(str[j-1]) != -1)
          j--;
      }
    }
    while (str[j-1] == "." || digits.indexOf(str[j-1]) != -1) j--;
    while (j > 0) {
      if (operations.indexOf(str[j-1]) == -1 && functions.indexOf(str[j-1]) == -1 && openbrackets.indexOf(str[j-1]) == -1
        && closebrackets.indexOf(str[j-1]) == -1 && str[j-1] != ",") {
          j--;
      }
      else {
        break;
      }
    }
    str = str.slice(0, j) + "pow(" + str.slice(j, i) + "," + exponent + ")" + str.slice(i + exponent.length + 3);
  }
  while (str.indexOf("Ä") != -1) {
    var i = str.indexOf("Ä");
    var j = str.lastIndexOf("Ä");
    if (j == i) {
      str += ")";
    } else {
      str = str.slice(0, j) + ")" + str.slice(j+1);
    }
    str = str.slice(0, i) + "abs(" + str.slice(i+1);
  }
  while (str.indexOf("!") != -1) {
    var i = str.indexOf("!");
    var j = i-1;
    while (digits.indexOf(str[j]) == -1 && j != "Å" && variables.indexOf(str[j]) != -1 && j > 0) j--;
    str = str.slice(0, j) + "factorial(" + str.slice(j, i) + ")" + str.slice(i+1);
  }
  while (str.indexOf("©") != -1) {
    let i = str.indexOf("©");
    let j = findOpeningBracket(str, str.lastIndexOf("}", i), open="{", close="}");
    str = str.slice(0, j) + "nCr(" + str.slice(j+1, i-1) + "," + str.slice(i+2);
  }
  while (str.indexOf("¦") != -1) {
    let i = str.indexOf("¦");
    let j = findOpeningBracket(str, str.lastIndexOf("}", i), open="{", close="}");
    str = str.slice(0, j) + "nPr(" + str.slice(j+1, i-1) + "," + str.slice(i+2);
  }
  str = str.replace(/Å/g, "ans");
  str = str.replace(/ýà/g, "tanh");
  str = str.replace(/ýç/g, "cosh");
  str = str.replace(/ýì/g, "sinh");
  str = str.replace(/ýÀ/g, "atanh");
  str = str.replace(/ýÇ/g, "acosh");
  str = str.replace(/ýÌ/g, "asinh");
  str = str.replace(/à/g, "tan_mode");
  str = str.replace(/ç/g, "cos_mode");
  str = str.replace(/ì/g, "sin_mode");
  str = str.replace(/À/g, "atan_mode");
  str = str.replace(/Ç/g, "acos_mode");
  str = str.replace(/Ì/g, "asin_mode");
  str = str.replace(/ł/g, "log");
  str = str.replace(/á/g, "/");
  str = str.replace(/[{]/g, "(");
  str = str.replace(/[}]/g, ")");
  str = str.replace(/π/g, "pi");
  str = str.replace(/ù/g, "sqrt");
  str = str.replace(/Ù/g, "cbrt");
  str = str.replace(/Ł/g, "log_mode");
  str = str.replace(/è/g, "e");
  str = str.replace(/ÿ/g, "*0.01");
  str = str.replace(/θ/g, "theta");
  str = str.replace(/¡/g, "a");
  str = str.replace(/¤/g, "b");
  str = str.replace(/¢/g, "c");
  str = str.replace(/£/g, "x");
  str = str.replace(/¥/g, "y");
  str = str.replace(/«/g, "z");
  str = str.replace(/Þ/g, "t");
  str = str.replace(/®/g, "r");
  str = str.replace(/¶/g, "m");
  str = str.replace(/£/g, "ñ");
  str = str.replace(/¿/g, "k");
  str = str.replace(/Â/g, "random()");
  str = str.replace(/\}©\{/g, ",");
  str = str.replace(/\}¦\{/g, ",");
  str = str.replace(/¸/g, "floor");
  str = str.replace(/¯/g, "ceil");
  return str;
}
function to_latex(str) {
  str = str.replace(/\*/g, " \\cdot ");
  str = str.replace(/Å/g, "\\text{ans}");
  str = str.replace(/\//g, " \\div ");
  str = str.replace(/ý/g, "\\text{hyp}");
  str = str.replace(/\\text{hyp}à/g, "\\tanh");
  str = str.replace(/\\text{hyp}ç/g, "\\cosh");
  str = str.replace(/\\text{hyp}ì/g, "\\sinh");
  str = str.replace(/\\text{hyp}À/g, "\\tanh^{-1}");
  str = str.replace(/\\text{hyp}Ç/g, "\\cosh^{-1}");
  str = str.replace(/\\text{hyp}Ì/g, "\\sinh^{-1}");
  str = str.replace(/à/g, "\\tan");
  str = str.replace(/ç/g, "\\cos");
  str = str.replace(/ì/g, "\\sin");
  str = str.replace(/À/g, "\\tan^{-1}");
  str = str.replace(/Ç/g, "\\cos^{-1}");
  str = str.replace(/Ì/g, "\\sin^{-1}");
  str = str.replace(/ł/g, "\\ln");
  str = str.replace(/π/g, "\\pi");
  str = str.replace(/ù/g, "\\sqrt");
  str = str.replace(/Ù/g, "\\sqrt[3]");
  str = str.replace(/Â/g, "\\text{rand}");
  if (logbase == 10)
    str = str.replace(/Ł/g, "\\log");
  else
    str = str.replace(/Ł/g, "\\log_{" + logbase + "}");
  str = str.replace(/è/g, "e");
  str = str.replace(/>/g, "\\rightarrow ");
  str = str.replace(/ÿ/g, "\\%");
  str = str.replace(/ß/g, "\\fbox{ \\vphantom{5} }");
  str = str.replace(/¡/g, "a");
  str = str.replace(/¤/g, "b");
  str = str.replace(/¢/g, "c");
  str = str.replace(/£/g, "x");
  str = str.replace(/¥/g, "y");
  str = str.replace(/«/g, "z");
  str = str.replace(/Þ/g, "t");
  str = str.replace(/®/g, "r");
  str = str.replace(/¶/g, "m");
  str = str.replace(/ñ/g, "n");
  str = str.replace(/¿/g, "k");
  str = str.replace(/\}©\{/g, "\\choose ");
  str = str.replace(/\}¦\{/g, "P");
  str = str.replace(/¸/g, "\\floor");
  str = str.replace(/¯/g, "\\ceil");
  for (var i = 0; i < str.length-1; i++) {
    if (str[i] == "(") {
      let j = findClosingBracket(str, i);
      if (j != -1) {
        str = str.slice(0, i) + "\\left" + str.slice(i);
        str = str.slice(0, j+5) + "\\right" + str.slice(j+5);
        i += 5;
      }
    } if (str[i] == "Ä") {
      let j = findClosingBracket(str, i, open="Ä", close="Ä");
      if (j == -1) {
        str = str.slice(0, i) + "\\lvert " + str.slice(i+1);
        i += 6;
      } else {
        str = str.slice(0, i) + "\\lvert " + str.slice(i+1);
        str = str.slice(0, j+6) + "\\rvert " + str.slice(j+7);
        i += 6;
      }
    }
  }
  while (str.indexOf("á") != -1) {
    let i = str.indexOf("á");
    let j = findOpeningBracket(str, str.lastIndexOf("}", i), open="{", close="}");
    str = str.slice(0, i) + str.slice(i+1);
    str = str.slice(0, j) + "\\frac" + str.slice(j);
  }
  return str;
}
function enter(onlydecimal=false) {
  var val;
  var storevar = null;
  if (memselect == -1) {
    commandmem.push(screentxt);
    if (screentxt[screentxt.length - 2] == ">" && variables.indexOf(screentxt[screentxt.length - 1]) != -1) {
      storevar = screentxt[screentxt.length - 1];
      screentxt = screentxt.slice(0, screentxt.length - 2);
    }
    try {
      while ((screentxt.match(/[(]/g) || []).length > (screentxt.match(/[)]/g) || []).length)
        screentxt += ")";
      if (screentxt[0] == "=") {
        val = scope.ans;
        commandmem[commandmem.length-1] = "Å";
      } else
        val = math.evaluate(to_eval(screentxt), scope);
      if  (val == undefined || isNaN(val) || !isFinite(val)) {
        throw new Error("Error in evaluating input");
      }
      scope.ans = val;
      val = new Number(val.toFixed(15));
      if (notation == 1 || Math.abs(val) >= Math.pow(10, 9) || (Math.abs(val) <= Math.pow(10, -7) && Math.abs(val) > 0)) {
        val = val.toExponential().toString();
        if (val.indexOf("e") > 12) {
          val = val.slice(0, 11) + val.slice(val.indexOf("e"));
        }
        let shift = 2;
        if (val[val.indexOf("e")+1] == "-") shift = 1;
        val = val.slice(0, val.indexOf("e")) + "\\cdot 10^{" + val.slice(val.indexOf("e")+shift) + "}";
      } else if (!onlydecimal && Math.abs(val - Math.round(val)) > Math.pow(10, -9) && screentxt.indexOf("ÿ") == -1) {
        for (var i = 2; i <= 100; i++) {
          if (Math.abs(Math.round(val*i) - val*i) < Math.pow(10, -9) && Math.abs(val) > Math.pow(10, -9)) {
            val = "\\frac{" + Math.round(val*i) + "}{" + i + "}";
            break;
          }
        }
      } else if (notation == 0 && screentxt.indexOf("ÿ") != -1) {
        val = Math.round(val*10000000.0)/100000.0 + "\\%";
      }
      switch(storevar) {
        case null: break;
        case "¡": scope.a = scope.ans; break;
        case "¤": scope.b = scope.ans; break;
        case "¢": scope.c = scope.ans; break;
        case "£": scope.x = scope.ans; break;
        case "¥": scope.y = scope.ans; break;
        case "«": scope.z = scope.ans; break;
        case "Þ": scope.t = scope.ans; break;
        case "®": scope.r = scope.ans; break;
        case "θ": scope.theta = scope.ans; break;
        case "¶": scope.m = scope.ans; break;
        case "ñ": scope.n = scope.ans; break;
        case "¿": scope.k = scope.ans; break;
      }
      mem.push(val);
      val = "=" + val.toString();
      document.getElementById("ans").style.textAlign = "right";
      screentxt = "";
      cursor = 0;
    } catch(err) {
      if (debugmode)
        val = "\\color{red}{\\text{ERROR: " + err.message + "}}";
      else
        val = "\\color{red}{\\text{ERROR}}";
      clearmem();
      mem.push("\\color{red}{\\text{ERROR}}");
    }
    updateMem(false);
    writescreen(val, false, true, false);
    clearWithButton = true;
  } else {
    if (memselect % 2 == 0)
      writescreen(commandmem[Math.floor(memselect / 2)].toString());
    else
      writescreen(mem[Math.floor(memselect / 2)].toString());
    memselect = -1;
    updateMem();
    updateMath();
    document.getElementById("screen").scrollTop = document.getElementById("screen").scrollHeight;
    document.getElementById("screen").scrollLeft = document.getElementById("screen").scrollWidth;
  }
}
function scrollright() {
  cursor++;
  while (screentxt[cursor] == "{" || doublefunctions.indexOf(screentxt[cursor]) != -1 || functions.indexOf(screentxt[cursor]) != -1)
    cursor++;
  if (cursor > screentxt.length)
    cursor = screentxt.length;
  if (screentxt[cursor] == "{") cursor--;
  writescreen("");
}
function scrollleft() {
  cursor--;
  while (screentxt[cursor] == "{" || doublefunctions.indexOf(screentxt[cursor]) != -1 || functions.indexOf(screentxt[cursor]) != -1)
    cursor--;
  if (cursor < 0)
    cursor = 0;
  if (screentxt[cursor] == "{") cursor++;
  writescreen("");
}

function findClosingBracket(str, pos, open='(', close=')') {
  if (str[pos] != open)
    throw new Error("No " + open + " at index " + pos);
  let depth = 1;
  for (let i = pos + 1; i < str.length; i++) {
    switch (str[i]) {
      case close:
        if (--depth == 0)
          return i;
        break;
      case open:
        depth++; break;
    }
  }
  return -1;
}

function findOpeningBracket(str, pos, open='(', close=')') {
  if (str[pos] != close)
    throw new Error("No " + close + " at index " + pos);
  let depth = 1;
  for (let i = pos - 1; i >= 0; i--) {
    switch (str[i]) {
      case close:
        depth++; break;
      case open:
        if (--depth == 0)
          return i;
        break;
    }
  }
  return -1;
}
function clearmem() {
  document.getElementById("membuffer").style.display = "block";
  updateMem();
  document.getElementById("mem").innerHTML += "<br><br><br><br><br><br><br><br>";
  document.getElementById("ans").innerHTML = "";
  screentxt = "";
  cursor = 0;
  updateMath();
  document.getElementById("screen").scrollTop = document.getElementById("screen").scrollHeight;
}
function clearallmem() {
  mem = [];
  commandmem = [];
  clearmem();
  switchbutton(0);
}

function deltxt() {
  var delchar = cursor;
  if (delchar == screentxt.length) delchar--;
  if (screentxt[delchar] == "}") {
    delchar--;
  }
  if (screentxt[delchar] == "{") {
    let end = findClosingBracket(screentxt, delchar, open='{', close='}');
    if (end == -1) {
      screentxt = screentxt.slice(0, delchar) + screentxt.slice(delchar+1);
    } else {
      screentxt = screentxt.slice(0, delchar) + screentxt.slice(end+1);
    }
    delchar--;
    if (delchar < 0) delchar = 0;
    if (doublefunctions.indexOf(screentxt[delchar]) != -1) {
      screentxt = screentxt.slice(0, delchar) + screentxt.slice(delchar+1);
      delchar--;
      if (screentxt[delchar] == "}") {
        let start = findOpeningBracket(screentxt, delchar, open='{', close='}');
        screentxt[delchar] = ")";
        screentxt[start] = "(";
      }
    }
    screentxt = screentxt.replace(/}/, ")");
    screentxt = screentxt.replace(/{/, "(");
  } else {
    screentxt = screentxt.slice(0, delchar) + screentxt.slice(delchar+1);
  }
  if (functions.indexOf(screentxt[delchar-1]) != -1)
    screentxt = screentxt.slice(0, delchar-1) + screentxt.slice(delchar);
  if (doublefunctions.indexOf(screentxt[cursor]) != -1) cursor--;
  if (cursor > screentxt.length) cursor = screentxt.length;
  if (cursor < 0) cursor = 0;
  writescreen("");
  return true;
}
function changeMode() {
  document.getElementById("screen").style.display = "none";
  document.getElementById("mode").style.display = "block";
  document.getElementById("prgm").style.display = "none";
  document.getElementById("selection").style.display = "none";
  screenview = 1;
}
function editPrgm() {
  document.getElementById("screen").style.display = "none";
  document.getElementById("mode").style.display = "none";
  document.getElementById("prgm").style.display = "block";
  document.getElementById("selection").style.display = "none";
  document.getElementById("prgm_txt").focus();
  screenview = 2;
  switchbutton(0);
}
function quit() {
  if (screenview == 1) {
    anglemode = new Number(document.mode.angle.value).valueOf();
    notation = new Number(document.mode.notation.value).valueOf();
    logbase = new Number(document.mode.logbase.value).valueOf();
    document.getElementById("mode").style.display = "none";
    document.getElementById("screen").style.display = "block";
    screenview = 0;
    debugmode = document.mode.debug.checked;
    document.body.className = document.mode.color.value;
    let color = document.mode.color.value;
    if (color == "abdussalam") {
      document.getElementById("maharashtra").style.display = "none";
      document.getElementById("punjab").style.display = "block";
    } else {
      document.getElementById("maharashtra").style.display = "block";
      document.getElementById("punjab").style.display = "none";
      let mi_m = document.getElementById("mi_m");
      let mi_svg = document.getElementById("mi_svg");
      let mi_txt = document.getElementById("mi_txt");
      let state = "Maharashtra";
      if (color == "" || color == "night") {
        mi_svg.style.visibility = "";
      } else
        mi_svg.style.visibility = "hidden";
      if (color == "")
        mi_m.style.fill = "#AAE0EE";
      else if (color == "night")
        mi_m.style.fill = "#111155";
      else if (color == "cathy")
        state = "Yunnan";
      else if (color == "washington")
        state = "Virginia";
      mi_txt.innerHTML = state + " Instruments";
      document.getElementById("calcname").innerHTML = state[0] + "I-\\(n\\)SPIRE CX II CAS";
      renderMathInElement(document.getElementById("calcname"));
    }
  } if (screenview == 2) {
    document.getElementById("prgm").style.display = "none";
    document.getElementById("screen").style.display = "block";
    screenview = 0;
  } if (screenview == 3) {
    document.getElementById("selection").style.display = "none";
    document.getElementById("screen").style.display = "block";
    screenview = 0;
    writescreen(document.selection.choice.value);
    if (document.selection.choice.value == "{}©{}" || document.selection.choice.value == "{}¦{}") {
      cursor -= 2;
      scrollleft();
    }
    if (document.selection.choice.value == "¯{}" || document.selection.choice.value == "¸{}")
      scrollleft();
  }
  updateMath();
}
function secondbutton() {
  if (buttonmode == 1)
    switchbutton(0);
  else
    switchbutton(1);
}
function alphabutton() {
  if (buttonmode == 2)
    switchbutton(0);
  else
    switchbutton(2);
}
function switchbutton(page) {
  if (page == 1)
    document.getElementById("second").className = "active button";
  else
    document.getElementById("second").className = "button";
  if (page == 2)
    document.getElementById("alpha").className = "active button";
  else
    document.getElementById("alpha").className = "button";
  buttonmode = page;
  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].attributes["data-bpage"] != undefined) {
      if (buttons[i].attributes["data-bpage"].value == page)
        buttons[i].style.display = "inline-block";
      else
        buttons[i].style.display = "none";
    }
  }
}
function keypress(event) {
  var u = event.which || event.keyCode;
  if (48 <= u && u <= 59) writescreen('' + (u-48));
  if (u == 45) writescreen('-');
  if (u == 43) writescreen("+");
  if (u == 61 || u == 13) enter();
  if (u == 46) writescreen(".");
  if (u == 47) writescreen("/");
  if (u == 42) writescreen("*");
  if (u == 40) writescreen("(");
  if (u == 41) writescreen(")");
  if (u == 67) clearmem();
  if (u == 37) writescreen("ÿ");
  if (u == 124) writescreen("Ä");
  if (u == 104) writescreen("ý");
  if (u == 101) writescreen("è");
  if (u == 62) writescreen(">");
  if (u == 97) writescreen("¡");
  if (u == 98) writescreen("¤");
  if (u == 99) writescreen("¢");
  if (u == 120) writescreen("£");
  if (u == 121) writescreen("¥");
  if (u == 122) writescreen("«");
  if (u == 116) writescreen("Þ");
  if (u == 114) writescreen("®");
  if (u == 109) writescreen("¶");
  if (u == 110) writescreen("ñ");
  if (u == 107) writescreen("¿");
  if (u == 102) fracbutton();
  if (u == 94) {
    writescreen('^{}', true, false); cursor += 2; writescreen('');
  }
}
function specialkeys(event) {
  var u = event.which || event.keyCode;
  if (u == 8 || u == 46) deltxt();
  if (u == 37) scrollleft();
  if (u == 39) scrollright();
  if (u == 16) switchbutton(1);
}
function specialkeysUp(event) {
  var u = event.which || event.keyCode;
  if (u == 16) switchbutton(0);
}
function execPrgm() {
  try {
    var code = document.getElementById("prgm_txt").innerHTML;
    code = code.replace(/<div>/g, "\n");
    code = code.replace(/<br>/g, "\n");
    code = code.replace(/<\/div>/g, "");
    eval(code);
  } catch(err) {
    writescreen("\\color{red}{\\text{ERROR: " + err.message + "}}", false, true);
    clearWithButton = true;
  }
}
function fracbutton() {
  writescreen('{}á{}', true, false); cursor++; writescreen('');
}
function choosefunction(functions, disp) {
  document.getElementById("screen").style.display = "none";
  document.getElementById("mode").style.display = "none";
  document.getElementById("prgm").style.display = "none";
  document.getElementById("selection").style.display = "block";
  while (document.selection.choice.options.length > 0)
    document.selection.choice.remove(0);
  for (var i = 0; i < functions.length; i++) {
    let option = document.createElement("option");
    option.innerHTML = disp[i];
    option.value = functions[i];
    document.selection.choice.add(option);
  }
  switchbutton(0);
  screenview = 3;
}
function scrollup() {
  if (memselect < 0) memselect = mem.length + commandmem.length - 1;
  else if (memselect > -1) memselect--;
  updateMem();
  writescreen("");
  if (memselect != -1)
    document.getElementById("screen").scrollTop = memDivs[memselect].offsetHeight * memselect - 30;
  document.getElementById("screen").scrollLeft = 0;
  switchbutton(1);
}
function scrolldown() {
  if (memselect >= mem.length + commandmem.length - 1) memselect = -1;
  else memselect++;
  updateMem();
  writescreen("");
  if (memselect != -1)
    document.getElementById("screen").scrollTop = memDivs[memselect].offsetHeight * memselect - 30;
  document.getElementById("screen").scrollLeft = 0;
  switchbutton(1);
}

window.onload = function() {
  writescreen("");
  document.body.addEventListener("keyup", specialkeysUp);
};

</script>

<br><br><br><br><br><br><br><br><br><br>
</body>
</html>
